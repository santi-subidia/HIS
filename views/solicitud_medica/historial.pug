extends ../layout

block content
  .row
    .col-lg-12.mb-4
      h3.text-primary.mb-4
        i.fas.fa-history.me-2
        | Historial de Estudios Médicos

  if internacion
    // Información del Paciente
    .card.mb-4.shadow(class=internacion.PacienteSeguro && internacion.PacienteSeguro.paciente ? '' : 'border-warning')
      .card-header(class=internacion.PacienteSeguro && internacion.PacienteSeguro.paciente ? 'bg-primary text-white' : 'bg-warning text-dark')
        h5.mb-0
          if internacion.PacienteSeguro && internacion.PacienteSeguro.paciente
            i.fas.fa-user.me-2
            | Información del Paciente
          else
            i.fas.fa-user-injured.me-2
            | Paciente de Emergencia (Desconocido)
      .card-body
        if internacion.PacienteSeguro && internacion.PacienteSeguro.paciente
          .row
            .col-md-4
              p.mb-2
                strong.text-muted Nombre:
                span.ms-2= internacion.PacienteSeguro.paciente.persona.nombre + ' ' + internacion.PacienteSeguro.paciente.persona.apellido
            .col-md-4
              p.mb-2
                strong.text-muted DNI:
                span.ms-2= internacion.PacienteSeguro.paciente.persona.DNI
            .col-md-4
              p.mb-2
                strong.text-muted Fecha de Internación:
                span.ms-2= internacion.fecha_internacion ? new Date(internacion.fecha_internacion).toLocaleDateString('es-AR') : '-'
        else
          .alert.alert-warning.mb-3
            i.fas.fa-exclamation-triangle.me-2
            strong Paciente internado de emergencia
            p.mb-0.mt-2 Los datos del paciente serán completados posteriormente.
          .row
            .col-md-4
              p.mb-2
                strong.text-muted Sexo:
                if internacion.isDesconocido === true
                  span.ms-2.badge.bg-info Masculino
                else if internacion.isDesconocido === false
                  span.ms-2.badge.bg-danger Femenino
                else
                  span.ms-2.text-muted No especificado
            .col-md-4
              p.mb-2
                strong.text-muted Ubicación:
                span.ms-2= internacion.Cama && internacion.Cama.Habitacion ? `Hab. ${internacion.Cama.Habitacion.codigo} - Cama ${internacion.Cama.numero_cama}` : '-'
            .col-md-4
              p.mb-2
                strong.text-muted Fecha de Internación:
                span.ms-2= internacion.fecha_internacion ? new Date(internacion.fecha_internacion).toLocaleDateString('es-AR') : '-'

    // Tabla de Estudios
    .card.shadow
      .card-header.bg-primary.text-white.d-flex.justify-content-between.align-items-center
        h5.mb-0
          i.fas.fa-microscope.me-2
          | Historial de Estudios
        a.btn.btn-light.btn-sm(href=`/estudios/crear/${internacion.id}`)
          i.fas.fa-plus.me-1
          | Solicitar Nuevo Estudio

      .card-body
        if solicitudes && solicitudes.length > 0
          .table-responsive
            table.table.table-hover.table-striped
              thead.table-primary
                tr
                  th.text-center
                    i.fas.fa-calendar.me-1
                    | Fecha Solicitud
                  th
                    i.fas.fa-flask.me-1
                    | Tipo de Estudio
                  th
                    i.fas.fa-user-md.me-1
                    | Médico
                  th.text-center
                    i.fas.fa-info-circle.me-1
                    | Estado
                  th.text-center
                    i.fas.fa-file.me-1
                    | Archivo
                  th.text-center
                    i.fas.fa-eye.me-1
                    | Acciones

              tbody
                each solicitud in solicitudes
                  tr
                    td.text-center
                      .d-flex.flex-column.align-items-center
                        span.badge.bg-secondary.mb-1= new Date(solicitud.fecha_solicitud).toLocaleDateString('es-AR')
                        small.text-muted= new Date(solicitud.fecha_solicitud).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' })
                    
                    td
                      span.badge.bg-primary.mb-1= solicitud.tipo_estudio.categoria.nombre
                      br
                      strong= solicitud.tipo_estudio.nombre
                    
                    td
                      i.fas.fa-user-md.text-primary.me-1
                      = solicitud.medico.persona.apellido + ', ' + solicitud.medico.persona.nombre
                    
                    td.text-center
                      if solicitud.fecha_completado
                        span.badge.bg-success
                          i.fas.fa-check-circle.me-1
                          | Completado
                        br
                        small.text-muted= new Date(solicitud.fecha_completado).toLocaleDateString('es-AR')
                      else
                        span.badge.bg-warning.text-dark
                          i.fas.fa-clock.me-1
                          | Pendiente
                    
                    td.text-center
                      if solicitud.url_file
                        a.btn.btn-sm.btn-info(href=solicitud.url_file target="_blank" title="Ver archivo")
                          i.fas.fa-file-download.me-1
                          | Ver
                      else
                        span.text-muted -
                    
                    td.text-center
                      a.btn.btn-sm.btn-primary(href=`/estudios/details/${solicitud.id}` title="Ver detalles completos")
                        i.fas.fa-eye.me-1
                        | Ver Detalles

          // Resumen
          .row.mt-4
            .col-md-6
              .alert.alert-info.d-flex.align-items-center
                i.fas.fa-check-circle.fa-2x.me-3
                div
                  strong Total de estudios:
                  span.ms-2= solicitudes.length
            .col-md-6
              .alert.alert-warning.d-flex.align-items-center
                i.fas.fa-clock.fa-2x.me-3
                div
                  strong Estudios pendientes:
                  span.ms-2= solicitudes.filter(s => !s.fecha_completado).length

        else
          .alert.alert-info.text-center
            i.fas.fa-info-circle.me-2
            | No hay estudios registrados para esta internación.
            br
            a.btn.btn-primary.btn-sm.mt-3(href=`/estudios/crear/${internacion.id}`)
              i.fas.fa-plus.me-1
              | Solicitar Primer Estudio

    // Botones de Navegación
    .row.mt-4.mb-4
      .col-12.d-flex.gap-2
        a.btn.btn-secondary(href=`/internacion/details/${internacion.id}`)
          i.fas.fa-arrow-left.me-2
          | Volver a Detalles
        a.btn.btn-outline-primary(href="/internacion")
          i.fas.fa-list.me-2
          | Ver Todas las Internaciones

  else
    .alert.alert-warning.mt-4 Internación no encontrada.
