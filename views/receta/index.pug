extends ../layout

block content
  .row
    .col-lg-12.mb-4
      h3.text-primary.mb-4
        i.fas.fa-prescription.me-2
        | Recetas Médicas

  if historial
    // Información del Paciente
    .card.mb-4.shadow
      .card-header.bg-primary.text-white
        h5.mb-0
          i.fas.fa-user.me-2
          | Información del Paciente
      .card-body
        .row
          .col-md-4
            p.mb-2
              strong.text-muted Nombre:
              span.ms-2= historial.paciente && historial.paciente.persona ? historial.paciente.persona.nombre + ' ' + historial.paciente.persona.apellido : '-'
          .col-md-4
            p.mb-2
              strong.text-muted DNI:
              span.ms-2= historial.paciente && historial.paciente.persona ? historial.paciente.persona.DNI : '-'
          .col-md-4
            p.mb-2
              strong.text-muted Historial Médico:
              span.ms-2 ID ##{historial.id}

    // Lista de Recetas
    .card.shadow
      .card-header.bg-success.text-white.d-flex.justify-content-between.align-items-center
        h5.mb-0
          i.fas.fa-list.me-2
          | Historial de Recetas
        a.btn.btn-light.btn-sm(href=`/recetas/crear?id_historial=${historial.id}`)
          i.fas.fa-plus.me-1
          | Nueva Receta

      .card-body
        if recetas && recetas.length > 0
          each receta, index in recetas
            .card.mb-3(class=index === 0 ? 'border-primary' : '')
              .card-header(class=index === 0 ? 'bg-primary text-white' : 'bg-light')
                .row.align-items-center
                  .col-md-4
                    h6.mb-0
                      i.fas.fa-prescription.me-2
                      | Receta ##{receta.id}
                      if index === 0
                        span.badge.bg-warning.text-dark.ms-2 Más Reciente
                  .col-md-4.text-center
                    small
                      i.fas.fa-calendar.me-1
                      = new Date(receta.fecha).toLocaleDateString('es-AR')
                      |  - 
                      = new Date(receta.fecha).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' })
                  .col-md-4.text-end
                    small
                      i.fas.fa-user-md.me-1
                      = receta.persona ? `${receta.persona.nombre} ${receta.persona.apellido}` : 'Sin registro'

              .card-body
                if receta.renglones && receta.renglones.length > 0
                  .table-responsive
                    table.table.table-sm.table-bordered.mb-0
                      thead.table-light
                        tr
                          th(style="width: 5%;") #
                          th(style="width: 25%;")
                            i.fas.fa-pills.me-1
                            | Medicamento
                          th(style="width: 20%;")
                            i.fas.fa-balance-scale.me-1
                            | Dosis
                          th(style="width: 15%;")
                            i.fas.fa-calendar-alt.me-1
                            | Duración
                          th(style="width: 35%;")
                            i.fas.fa-comment-medical.me-1
                            | Indicaciones
                      tbody
                        each renglon, idx in receta.renglones
                          tr
                            td.text-center= idx + 1
                            td
                              if renglon.medicamento
                                strong= renglon.medicamento.marca_comercial
                                br
                                small.text-muted= renglon.medicamento.presentacion
                                br
                                small.text-muted.fst-italic Lab: #{renglon.medicamento.laboratorio}
                              else
                                span.text-muted Medicamento no disponible
                            td= renglon.dosis
                            td= renglon.duracion
                            td= renglon.indicaciones || '-'
                else
                  .alert.alert-warning.mb-0
                    i.fas.fa-exclamation-triangle.me-2
                    | Esta receta no tiene medicamentos asociados

            if index < recetas.length - 1
              hr.my-4

          // Resumen
          .row.mt-4
            .col-12
              .alert.alert-info.mb-0
                i.fas.fa-info-circle.me-2
                strong Total de recetas emitidas:
                span.ms-2= recetas.length
                |  receta(s)

        else
          .alert.alert-info.text-center
            i.fas.fa-info-circle.me-2
            | No hay recetas registradas para este historial médico.
            br
            a.btn.btn-success.btn-sm.mt-3(href=`/recetas/crear?id_historial=${historial.id}`)
              i.fas.fa-plus.me-1
              | Crear Primera Receta

    // Botones de Navegación
    .row.mt-4.mb-4
      .col-12.d-flex.gap-2
        a.btn.btn-secondary(href=`/historial-medico/${historial.id_paciente}`)
          i.fas.fa-arrow-left.me-2
          | Volver al Historial Médico
        a.btn.btn-outline-primary(href=`/paciente`)
          i.fas.fa-users.me-2
          | Ver Pacientes

  else
    .alert.alert-warning.mt-4 Historial médico no encontrado.
