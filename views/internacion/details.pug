extends ../layout

block content
  .row
    .col-lg-12.mb-4
      h3.text-primary.mb-4
        i.fas.fa-bed.me-2
        | Detalles de la Internaci贸n

  if internacion
    if internacion.PacienteSeguro && internacion.PacienteSeguro.paciente
      // Informaci贸n del Paciente
      .card.mt-4.shadow
        .card-header.bg-primary.text-white
          h5.mb-0
            i.fas.fa-user.me-2
            | Informaci贸n del Paciente
          a.btn.btn-light.btn-sm.float-end(href=`/historial-medico/${internacion.PacienteSeguro.paciente.id}` style="position: absolute; right: 15px; top: 12px;")
            i.fas.fa-notes-medical.me-1
            | Ver Historial M茅dico
        .card-body
          .row.mb-3
            .col-md-6
              p.mb-2
                strong.text-muted DNI:
                span.ms-2= internacion.PacienteSeguro.paciente.persona.DNI
            .col-md-6
              p.mb-2
                strong.text-muted Nombre Completo:
                span.ms-2= internacion.PacienteSeguro.paciente.persona.nombre + ' ' + internacion.PacienteSeguro.paciente.persona.apellido
          .row.mb-3
            .col-md-6
              p.mb-2
                strong.text-muted Sexo:
                span.ms-2= internacion.PacienteSeguro.paciente.sexo
            .col-md-6
              p.mb-2
                strong.text-muted Fecha de Nacimiento:
                span.ms-2= internacion.PacienteSeguro.paciente.fecha_nacimiento ? new Date(internacion.PacienteSeguro.paciente.fecha_nacimiento).toLocaleDateString('es-AR') : '-'
          .row
            .col-md-6
              p.mb-2
                strong.text-muted Seguro M茅dico:
                span.ms-2= internacion.PacienteSeguro.seguro ? internacion.PacienteSeguro.seguro.nombre : '-'
            .col-md-6
              p.mb-2
                strong.text-muted C贸digo de Afiliado:
                span.ms-2= internacion.PacienteSeguro.codigo_afiliado
    else
      // Paciente de Emergencia (Desconocido)
      .card.mt-4.shadow
        .card-header.bg-warning.text-dark
          h5.mb-0
            i.fas.fa-user-injured.me-2
            | Paciente de Emergencia (Datos Desconocidos)
        .card-body
          .alert.alert-warning
            i.fas.fa-exclamation-triangle.me-2
            strong Internaci贸n de Emergencia
            p.mb-0.mt-2 Este paciente fue internado de emergencia sin datos completos. Complete la informaci贸n del paciente cuando est茅 disponible.
          .row.mb-3
            .col-md-12
              p.mb-2
                strong.text-muted Sexo del Paciente:
                if internacion.isDesconocido === true
                  span.ms-2.badge.bg-info Masculino
                else if internacion.isDesconocido === false
                  span.ms-2.badge.bg-danger Femenino
                else
                  span.ms-2.text-muted No especificado
          
          // Bot贸n para completar datos (solo Enfermeros y Admin)
          if usuario.rol === 'Enfermero' || usuario.rol === 'Admin' || usuario.rol === 'Recepcionista'
            .row.mt-3
              .col-md-12
                a.btn.btn-primary.btn-lg.w-100(href=`/internacion/completar-datos/${internacion.id}`)
                  i.fas.fa-user-plus.me-2
                  | Completar Datos del Paciente

    // Informaci贸n de la Internaci贸n
    .card.mt-4.shadow
      .card-header.bg-info.text-white
        h5.mb-0
          i.fas.fa-hospital.me-2
          | Informaci贸n de la Internaci贸n
      .card-body
        .row.mb-3
          .col-md-4
            p.mb-2
              strong.text-muted Fecha de Ingreso:
              span.ms-2= internacion.fecha_internacion ? new Date(internacion.fecha_internacion).toLocaleDateString('es-AR') + ' ' + new Date(internacion.fecha_internacion).toLocaleTimeString('es-AR') : '-'
          .col-md-4
            p.mb-2
              strong.text-muted Estado:
              if internacion.estado === 'activa'
                span.badge.bg-success.ms-2= internacion.estado
              else if internacion.estado === 'alta'
                span.badge.bg-secondary.ms-2= internacion.estado
              else
                span.badge.bg-warning.ms-2= internacion.estado
          .col-md-4
            p.mb-2
              strong.text-muted Prioridad:
              if internacion.prioridad === 'alta'
                span.badge.bg-danger.ms-2= internacion.prioridad
              else if internacion.prioridad === 'media'
                span.badge.bg-warning.ms-2= internacion.prioridad
              else if internacion.prioridad === 'baja'
                span.badge.bg-info.ms-2= internacion.prioridad
              else
                span.badge.bg-secondary.ms-2 Sin asignar
              button.btn.btn-sm.btn-outline-primary.ms-2(type="button" data-bs-toggle="modal" data-bs-target="#modalPrioridad")
                i.fas.fa-edit.me-1
                | Cambiar
        .row.mb-3
          .col-md-12
            p.mb-2
              strong.text-muted Motivo:
              span.ms-2= internacion.Motivo ? internacion.Motivo.nombre : '-'
        .row
          .col-md-12
            p.mb-2
              strong.text-muted Detalle del Motivo:
              p.ms-2.mt-2= internacion.detalle_motivo || '-'

    // Ubicaci贸n
    .card.mt-4.shadow
      .card-header.bg-success.text-white
        h5.mb-0
          i.fas.fa-map-marker-alt.me-2
          | Ubicaci贸n
      .card-body
        .row.mb-3
          .col-md-3
            p.mb-2
              strong.text-muted Sector:
              span.ms-2= internacion.Cama && internacion.Cama.Habitacion && internacion.Cama.Habitacion.Ala && internacion.Cama.Habitacion.Ala.Sector ? internacion.Cama.Habitacion.Ala.Sector.nombre : '-'
          .col-md-3
            p.mb-2
              strong.text-muted Ala:
              span.ms-2= internacion.Cama && internacion.Cama.Habitacion && internacion.Cama.Habitacion.Ala ? internacion.Cama.Habitacion.Ala.ubicacion : '-'
          .col-md-3
            p.mb-2
              strong.text-muted Habitaci贸n:
              span.ms-2= internacion.Cama && internacion.Cama.Habitacion ? internacion.Cama.Habitacion.codigo : '-'
          .col-md-3
            p.mb-2
              strong.text-muted Cama:
              span.ms-2= internacion.Cama ? 'Cama ' + internacion.Cama.numero_cama : '-'

    if internacion.ContactoEmergencia && internacion.ContactoEmergencia.persona
      // Contacto de Emergencia
      .card.mt-4.shadow
        .card-header.bg-danger.text-white
          h5.mb-0
            i.fas.fa-phone.me-2
            | Contacto de Emergencia
        .card-body
          .row.mb-3
            .col-md-6
              p.mb-2
                strong.text-muted Nombre:
                span.ms-2= internacion.ContactoEmergencia.persona.nombre + ' ' + internacion.ContactoEmergencia.persona.apellido
            .col-md-6
              p.mb-2
                strong.text-muted Parentesco:
                span.ms-2= internacion.ContactoEmergencia.Parentesco ? internacion.ContactoEmergencia.Parentesco.nombre : '-'
          .row
            .col-md-6
              p.mb-2
                strong.text-muted DNI:
                span.ms-2= internacion.ContactoEmergencia.persona.DNI
            .col-md-6
              p.mb-2
                strong.text-muted Tel茅fono:
                span.ms-2= internacion.ContactoEmergencia.persona.telefono

    // Acciones
    .card.mt-4.shadow.border-primary
      .card-header.bg-light
        h5.mb-0
          i.fas.fa-tasks.me-2
          | Acciones y Registros
      .card-body
        .row.g-3
          // Signos Vitales
          .col-md-6.col-lg-4
            .card.h-100.border-primary.shadow-sm.hover-shadow(style="transition: transform 0.2s;")
              .card-body.text-center.p-4
                .mb-3
                  i.fas.fa-heartbeat.fa-3x.text-primary
                h5.card-title.mb-2 Signos Vitales
                p.card-text.text-muted.small Registrar y consultar signos vitales del paciente
                .d-grid.gap-2.mt-3
                  a.btn.btn-primary.btn-sm(href=`/enfermeria/signos-vitales/registrar/${internacion.id}`)
                    i.fas.fa-plus.me-1
                    | Registrar
                  a.btn.btn-outline-primary.btn-sm(href=`/enfermeria/signos-vitales/${internacion.id}`)
                    i.fas.fa-list.me-1
                    | Ver Historial
          
          // Plan de Cuidado
          .col-md-6.col-lg-4
            .card.h-100.border-success.shadow-sm.hover-shadow(style="transition: transform 0.2s;")
              .card-body.text-center.p-4
                .mb-3
                  i.fas.fa-clipboard-list.fa-3x.text-success
                h5.card-title.mb-2 Plan de Cuidado
                p.card-text.text-muted.small Crear y gestionar planes de cuidado
                .d-grid.gap-2.mt-3
                  a.btn.btn-success.btn-sm(href=`/enfermeria/planes-cuidado/crear/${internacion.id}`)
                    i.fas.fa-plus.me-1
                    | Crear Plan
                  a.btn.btn-outline-success.btn-sm(href=`/enfermeria/planes-cuidado/${internacion.id}`)
                    i.fas.fa-list.me-1
                    | Ver Planes
          
          // Solicitudes de Atenci贸n (solo Enfermeros)
          if usuario.rol === 'Enfermero' || usuario.rol === 'Admin'
            .col-md-6.col-lg-4
              .card.h-100.border-warning.shadow-sm.hover-shadow(style="transition: transform 0.2s;")
                .card-body.text-center.p-4
                  .mb-3
                    i.fas.fa-bell.fa-3x.text-warning
                  h5.card-title.mb-2 Solicitud de Atenci贸n
                  p.card-text.text-muted.small Notificar al equipo m茅dico sobre situaciones urgentes
                  .d-grid.gap-2.mt-3
                    a.btn.btn-warning.btn-sm(href=`/solicitudes-atencion/crear/${internacion.id}`)
                      i.fas.fa-bell.me-1
                      | Solicitar Atenci贸n
          
          // Estudios M茅dicos (solo M茅dicos, Recepcionistas y Admin)
          if usuario.rol === 'Medico' || usuario.rol === 'Recepcionista' || usuario.rol === 'Admin'
            .col-md-6.col-lg-4
              .card.h-100.border-info.shadow-sm.hover-shadow(style="transition: transform 0.2s;")
                .card-body.text-center.p-4
                  .mb-3
                    i.fas.fa-microscope.fa-3x.text-info
                  h5.card-title.mb-2 Estudios M茅dicos
                  p.card-text.text-muted.small Solicitar estudios y ver resultados
                  .d-grid.gap-2.mt-3
                    a.btn.btn-info.btn-sm(href=`/estudios/crear/${internacion.id}`)
                      i.fas.fa-plus.me-1
                      | Solicitar Estudio
                    a.btn.btn-outline-info.btn-sm(href=`/estudios/historial/${internacion.id}`)
                      i.fas.fa-list.me-1
                      | Ver Historial

          // Dar de Alta (solo M茅dicos, Recepcionistas y Admin - si est谩 activa)
          if internacion.estado === 'activa' && (usuario.rol === 'Medico' || usuario.rol === 'Recepcionista' || usuario.rol === 'Admin')
            .col-md-6.col-lg-4
              .card.h-100.border-danger.shadow-sm.hover-shadow(style="transition: transform 0.2s;")
                .card-body.text-center.p-4
                  .mb-3
                    i.fas.fa-door-open.fa-3x.text-danger
                  h5.card-title.mb-2 Dar de Alta
                  p.card-text.text-muted.small Finalizar la internaci贸n del paciente
                  .d-grid.gap-2.mt-3
                    a.btn.btn-danger.btn-sm(href=`/alta/crear/${internacion.id}`)
                      i.fas.fa-check-circle.me-1
                      | Dar de Alta
          
          // Ver Alta (solo si ya tiene alta)
          if internacion.estado === 'alta'
            .col-md-6.col-lg-4
              .card.h-100.border-secondary.shadow-sm.hover-shadow(style="transition: transform 0.2s;")
                .card-body.text-center.p-4
                  .mb-3
                    i.fas.fa-file-medical.fa-3x.text-secondary
                  h5.card-title.mb-2 Alta Registrada
                  p.card-text.text-muted.small Ver detalles del alta del paciente
                  .d-grid.gap-2.mt-3
                    a.btn.btn-secondary.btn-sm(href=`/alta/details/${internacion.id}`)
                      i.fas.fa-eye.me-1
                      | Ver Detalles del Alta

    // Historial de Solicitudes de Atenci贸n
    if solicitudes && solicitudes.length > 0
      .card.mt-4.shadow
        .card-header.bg-warning.text-dark
          h5.mb-0
            i.fas.fa-history.me-2
            | Historial de Solicitudes de Atenci贸n
            span.badge.bg-dark.ms-2 #{solicitudes.length}
        .card-body
          .table-responsive
            table.table.table-hover.table-bordered
              thead.table-warning
                tr
                  th Estado
                  th Fecha Solicitud
                  th Motivo
                  th Enfermero
                  th M茅dico
                  th Respuesta
              tbody
                each solicitud in solicitudes
                  tr
                    td
                      if solicitud.estado === 'Pendiente'
                        span.badge.bg-warning Pendiente
                      else if solicitud.estado === 'Atendida'
                        span.badge.bg-success Atendida
                      else if solicitud.estado === 'Rechazada'
                        span.badge.bg-danger Rechazada
                    td
                      small= new Date(solicitud.fecha_solicitud).toLocaleString('es-AR')
                    td
                      strong= solicitud.motivo
                      br
                      small.text-muted= solicitud.descripcion.substring(0, 50) + '...'
                    td= solicitud.Enfermero.persona.apellido + ', ' + solicitud.Enfermero.persona.nombre
                    td
                      if solicitud.Medico
                        = solicitud.Medico.persona.apellido + ', ' + solicitud.Medico.persona.nombre
                        br
                        small.text-muted= new Date(solicitud.fecha_respuesta).toLocaleString('es-AR')
                      else
                        span.text-muted Sin asignar
                    td
                      if solicitud.respuesta
                        = solicitud.respuesta
                      else
                        span.text-muted Pendiente de respuesta

    // Bot贸n Volver
    .row.mt-4.mb-4
      .col-12
        a.btn.btn-secondary(href="/internacion")
          i.fas.fa-arrow-left.me-2
          | Volver a la Lista

    // Modal para cambiar prioridad
    .modal.fade#modalPrioridad(tabindex="-1" aria-labelledby="modalPrioridadLabel" aria-hidden="true")
      .modal-dialog
        .modal-content
          .modal-header
            h5.modal-title#modalPrioridadLabel
              i.fas.fa-exclamation-triangle.me-2
              | Cambiar Prioridad de Internaci贸n
            button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
          form(action=`/internacion/cambiar-prioridad/${internacion.id}` method="POST")
            .modal-body
              .mb-3
                label.form-label(for="prioridad") Seleccione la nueva prioridad:
                select#prioridad.form-select(name="prioridad" required)
                  option(value="" disabled selected) Seleccione una opci贸n
                  option(value="baja" selected=internacion.prioridad === 'baja')  Baja
                  option(value="media" selected=internacion.prioridad === 'media')  Media
                  option(value="alta" selected=internacion.prioridad === 'alta')  Alta
              .alert.alert-info.mb-0
                i.fas.fa-info-circle.me-2
                strong Niveles de Prioridad:
                ul.mb-0.mt-2
                  li  <strong>Baja:</strong> Paciente estable, sin urgencias
                  li  <strong>Media:</strong> Requiere atenci贸n regular
                  li  <strong>Alta:</strong> Requiere atenci贸n inmediata
            .modal-footer
              button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancelar
              button.btn.btn-primary(type="submit")
                i.fas.fa-save.me-1
                | Guardar Cambios

  else
    .alert.alert-warning.mt-4 Internaci贸n no encontrada.

  style.
    .hover-shadow:hover {
      transform: translateY(-5px);
      box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important;
    }
