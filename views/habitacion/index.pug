extends ../layout

block content
  h2.mb-4 Gestión de Habitaciones

  // Filtros
  form.mb-3.d-flex.gap-3(method="GET", action="/habitacion")
    select.form-select(name="id_sector")
      option(value="" selected) Todos los Sectores
      each sector in sectores
        option(value=sector.id selected=(filters && filters.id_sector == sector.id))= sector.nombre
    select.form-select(name="estado")
      option(value="" selected) Todos los Estados
      option(value="disponible" selected=(filters && filters.estado === 'disponible')) Disponible
      option(value="ocupada" selected=(filters && filters.estado === 'ocupada')) Ocupada
      option(value="mantenimiento" selected=(filters && filters.estado === 'mantenimiento')) Mantenimiento
    button.btn.btn-primary(type="submit") Filtrar
    if filters && (filters.id_sector || filters.estado)
      a.btn.btn-secondary(href="/habitacion") Limpiar

  if mensaje
    div.alert.alert-danger= mensaje

  if success
    div.alert.alert-success.alert-dismissible.fade.show(role='alert')
      i.bi.bi-check-circle.me-2
      = success
      button.btn-close(type='button' data-bs-dismiss='alert')

  if habitaciones.length
    table.table.table-striped
      thead
        tr
          th Sector
          th Ala
          th Habitación
          th Cama
          th Estado
          th Acciones
      tbody
        each habitacion in habitaciones
          each cama in habitacion.Camas
            tr
              td= habitacion.Ala && habitacion.Ala.Sector ? habitacion.Ala.Sector.nombre : '-'
              td= habitacion.Ala ? habitacion.Ala.ubicacion : '-'
              td= habitacion.codigo
              td= cama.numero_cama
              td
                if cama.estado === 'disponible'
                  span.badge.bg-success Disponible
                else if cama.estado === 'ocupada'
                  span.badge.bg-danger Ocupada
                else if cama.estado === 'mantenimiento'
                  span.badge.bg-warning.text-dark Mantenimiento
                else
                  span.badge.bg-secondary= cama.estado
              td
                if cama.estado === 'mantenimiento'
                  button.btn.btn-success.btn-sm(type='button' data-bs-toggle='modal' data-bs-target=`#disponibleModal${cama.id}`)
                    i.bi.bi-check-circle.me-1
                    | Marcar Disponible
                else
                  span.text-muted -

    // Modales para cada cama en mantenimiento
    each habitacion in habitaciones
      each cama in habitacion.Camas
        if cama.estado === 'mantenimiento'
          .modal.fade(id=`disponibleModal${cama.id}` tabindex='-1' aria-labelledby=`disponibleModalLabel${cama.id}` aria-hidden='true')
            .modal-dialog.modal-dialog-centered
              .modal-content
                .modal-header.bg-success.text-white
                  h5.modal-title(id=`disponibleModalLabel${cama.id}`)
                    i.bi.bi-check-circle.me-2
                    | Marcar Cama como Disponible
                  button.btn-close.btn-close-white(type='button' data-bs-dismiss='modal' aria-label='Close')
                .modal-body
                  p
                    strong ¿Confirma que esta cama ya está lista para ser ocupada?
                  hr
                  p.mb-1
                    strong Sector: 
                    = habitacion.Ala && habitacion.Ala.Sector ? habitacion.Ala.Sector.nombre : '-'
                  p.mb-1
                    strong Ala: 
                    = habitacion.Ala ? habitacion.Ala.ubicacion : '-'
                  p.mb-1
                    strong Habitación: 
                    = habitacion.codigo
                  p.mb-0
                    strong Cama: 
                    = cama.numero_cama
                  .alert.alert-info.mt-3.mb-0
                    i.bi.bi-info-circle.me-2
                    | La cama quedará disponible para nuevas internaciones
                .modal-footer
                  button.btn.btn-secondary(type='button' data-bs-dismiss='modal') Cancelar
                  form(method='POST' action=`/habitacion/marcar-disponible/${cama.id}` style='display: inline;')
                    button.btn.btn-success(type='submit')
                      i.bi.bi-check-circle.me-1
                      | Confirmar
  else
    div.alert.alert-info No hay habitaciones registradas.