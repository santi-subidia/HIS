extends ../layout

block content
  .row
    .col-lg-12.mb-4
      h3.text-success.mb-4
        i.fas.fa-clipboard-list.me-2
        | Crear Plan de Cuidado

  if internacion
    // Información del Paciente
    .card.mb-4.shadow(class=internacion.PacienteSeguro && internacion.PacienteSeguro.paciente ? '' : 'border-warning')
      .card-header(class=internacion.PacienteSeguro && internacion.PacienteSeguro.paciente ? 'bg-primary text-white' : 'bg-warning text-dark')
        h5.mb-0
          if internacion.PacienteSeguro && internacion.PacienteSeguro.paciente
            i.fas.fa-user.me-2
            | Información del Paciente
          else
            i.fas.fa-user-injured.me-2
            | Paciente de Emergencia (Desconocido)
      .card-body
        if internacion.PacienteSeguro && internacion.PacienteSeguro.paciente
          .row
            .col-md-6
              p.mb-2
                strong.text-muted Nombre:
                span.ms-2= internacion.PacienteSeguro.paciente.persona.nombre + ' ' + internacion.PacienteSeguro.paciente.persona.apellido
            .col-md-6
              p.mb-2
                strong.text-muted DNI:
                span.ms-2= internacion.PacienteSeguro.paciente.persona.DNI
          .row
            .col-md-6
              p.mb-2
                strong.text-muted Ubicación:
                span.ms-2= internacion.Cama && internacion.Cama.Habitacion ? `${internacion.Cama.Habitacion.Ala.Sector.nombre} - ${internacion.Cama.Habitacion.Ala.ubicacion} - Hab. ${internacion.Cama.Habitacion.codigo} - Cama ${internacion.Cama.numero_cama}` : '-'
            .col-md-6
              p.mb-2
                strong.text-muted Fecha de Internación:
                span.ms-2= internacion.fecha_internacion ? new Date(internacion.fecha_internacion).toLocaleDateString('es-AR') : '-'
        else
          .alert.alert-warning.mb-3
            i.fas.fa-exclamation-triangle.me-2
            strong Paciente internado de emergencia
            p.mb-0.mt-2 Los datos del paciente serán completados posteriormente.
          .row
            .col-md-4
              p.mb-2
                strong.text-muted Sexo:
                if internacion.isDesconocido === true
                  span.ms-2.badge.bg-info Masculino
                else if internacion.isDesconocido === false
                  span.ms-2.badge.bg-danger Femenino
                else
                  span.ms-2.text-muted No especificado
            .col-md-4
              p.mb-2
                strong.text-muted Ubicación:
                span.ms-2= internacion.Cama && internacion.Cama.Habitacion ? `Hab. ${internacion.Cama.Habitacion.codigo} - Cama ${internacion.Cama.numero_cama}` : '-'
            .col-md-4
              p.mb-2
                strong.text-muted Fecha de Internación:
                span.ms-2= internacion.fecha_internacion ? new Date(internacion.fecha_internacion).toLocaleDateString('es-AR') : '-'

    // Formulario de Plan de Cuidado
    .card.shadow
      .card-header.bg-success.text-white
        h5.mb-0
          i.fas.fa-notes-medical.me-2
          | Registrar Plan de Cuidado
      .card-body
        form(action=`/enfermeria/planes-cuidado/crear/${internacion.id}` method="POST")
          // Tipo de Plan (automático)
          input(type="hidden" name="id_tipo" value=tipoAutomatico)
          
          // URL de retorno (si viene desde alta)
          if returnUrl
            input(type="hidden" name="returnUrl" value=returnUrl)
          
          if esFinal
            .alert.alert-info.mb-3
              i.fas.fa-info-circle.me-2
              strong Plan Final de Cuidado
              p.mb-0.mt-2 Este es el plan definitivo para el alta del paciente
          else
            .alert.alert-info.mb-3
              i.fas.fa-info-circle.me-2
              strong Plan Transitorio de Cuidado
              p.mb-0.mt-2 Este plan tiene duración limitada durante la internación
          
          .row
            // Receta Médica (opcional)
            .col-md-12.mb-3
              label.form-label
                i.fas.fa-prescription.me-1
                | Receta Médica (opcional)
              if id_receta
                input(type="hidden" name="id_reseta" value=id_receta)
                .alert.alert-success.mb-0
                  i.fas.fa-check-circle.me-2
                  | Receta ##{id_receta} creada y vinculada correctamente
              else
                a.btn.btn-outline-primary.w-100(
                  href=`/recetas/crear?id_internacion=${internacion.id}&return=/enfermeria/planes-cuidado/crear/${internacion.id}${esFinal ? '?desde_alta=true' : ''}`
                )
                  i.fas.fa-plus.me-2
                  | Crear Receta Médica
                .form-text.mt-2
                  i.fas.fa-info-circle.me-1
                  | Si el paciente necesita medicación, puede crear una receta. Se vinculará automáticamente

          // Diagnóstico y Tratamiento
          .row
            .col-md-12.mb-3
              label.form-label(for="diagnostico")
                i.fas.fa-stethoscope.me-1
                | Diagnóstico
                span.text-danger *
              textarea#diagnostico.form-control(
                name="diagnostico"
                rows="3"
                required
                minlength="2"
                maxlength="100"
                placeholder="Describa el diagnóstico del paciente (máximo 100 caracteres)"
              )
              .form-text 
                span#charCountDiag 0
                |  / 100 caracteres
          
          .row
            .col-md-12.mb-3
              label.form-label(for="tratamiento")
                i.fas.fa-notes-medical.me-1
                | Tratamiento
                span.text-danger *
              textarea#tratamiento.form-control(
                name="tratamiento"
                rows="3"
                required
                minlength="2"
                maxlength="100"
                placeholder="Describa el tratamiento a seguir (máximo 100 caracteres)"
              )
              .form-text 
                span#charCountTrat 0
                |  / 100 caracteres

          // Información adicional
          .alert.alert-info.mb-3
            i.fas.fa-info-circle.me-2
            div
              strong Nota:
              ul.mb-0.mt-2
                li El plan de cuidado quedará registrado con la fecha y hora actual
                li El plan <strong>Transitorio</strong> con menor tiempo será considerado el <strong>plan inicial</strong>
                li El plan <strong>Final</strong> es el definitivo para el alta del paciente
                li Puede asociar una receta médica si el paciente necesita medicación

          // Botones
          .row
            .col-md-12.d-flex.justify-content-end.gap-2
              a.btn.btn-secondary(href=`/internacion/details/${internacion.id}`)
                i.fas.fa-times.me-1
                | Cancelar
              button.btn.btn-success(type="submit")
                i.fas.fa-save.me-1
                | Guardar Plan de Cuidado

  else
    .alert.alert-warning.mt-4 Internación no encontrada.

  // Script para contador de caracteres y manejo de receta
  script.
    // Contador para Diagnóstico
    document.getElementById('diagnostico').addEventListener('input', function() {
      const charCount = this.value.length;
      const counter = document.getElementById('charCountDiag');
      counter.textContent = charCount;
      
      if (charCount > 100) {
        counter.classList.add('text-danger');
        counter.classList.remove('text-muted');
      } else if (charCount > 80) {
        counter.classList.add('text-warning');
        counter.classList.remove('text-danger', 'text-muted');
      } else {
        counter.classList.add('text-muted');
        counter.classList.remove('text-danger', 'text-warning');
      }
    });
    
    // Contador para Tratamiento
    document.getElementById('tratamiento').addEventListener('input', function() {
      const charCount = this.value.length;
      const counter = document.getElementById('charCountTrat');
      counter.textContent = charCount;
      
      if (charCount > 100) {
        counter.classList.add('text-danger');
        counter.classList.remove('text-muted');
      } else if (charCount > 80) {
        counter.classList.add('text-warning');
        counter.classList.remove('text-danger', 'text-muted');
      } else {
        counter.classList.add('text-muted');
        counter.classList.remove('text-danger', 'text-warning');
      }
    });

    // Manejar apertura de ventana de receta y actualización automática
    //- const btnNuevaReceta = document.getElementById('btnNuevaReceta');
    //- if (btnNuevaReceta) {
    //-   btnNuevaReceta.addEventListener('click', function(e) {
    //-     e.preventDefault();
    //-     const url = this.getAttribute('href');
        
    //-     // Abrir en nueva ventana
    //-     const ventana = window.open(url, 'CrearReceta', 'width=1200,height=800');
        
    //-     // Escuchar mensajes de la ventana hija (opcional, para cerrar automáticamente)
    //-     window.addEventListener('message', function(event) {
    //-       if (event.data.type === 'receta_creada') {
    //-         // La ventana hija envió el ID de la receta
    //-         document.getElementById('id_reseta').value = event.data.id_receta;
    //-         document.getElementById('id_reseta').readOnly = true;
    //-         ventana.close();
    //-       }
    //-     });
    //-   });
    //- }
