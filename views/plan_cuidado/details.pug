extends ../layout

block content
  .row
    .col-lg-12.mb-4
      h3.text-success.mb-4
        i.fas.fa-clipboard-list.me-2
        | Detalles del Plan de Cuidado

  if plan
    // Información del Paciente
    .card.mb-4.shadow(class=plan.internacion && plan.internacion.PacienteSeguro && plan.internacion.PacienteSeguro.paciente ? '' : 'border-warning')
      .card-header(class=plan.internacion && plan.internacion.PacienteSeguro && plan.internacion.PacienteSeguro.paciente ? 'bg-primary text-white' : 'bg-warning text-dark')
        h5.mb-0
          if plan.internacion && plan.internacion.PacienteSeguro && plan.internacion.PacienteSeguro.paciente
            i.fas.fa-user.me-2
            | Información del Paciente
          else
            i.fas.fa-user-injured.me-2
            | Paciente de Emergencia (Desconocido)
      .card-body
        if plan.internacion && plan.internacion.PacienteSeguro && plan.internacion.PacienteSeguro.paciente
          .row
            .col-md-3
              p.mb-2
                strong.text-muted Nombre:
                span.ms-2= plan.internacion.PacienteSeguro.paciente.persona.nombre + ' ' + plan.internacion.PacienteSeguro.paciente.persona.apellido
            .col-md-3
              p.mb-2
                strong.text-muted DNI:
                span.ms-2= plan.internacion.PacienteSeguro.paciente.persona.DNI
            .col-md-3
              p.mb-2
                strong.text-muted Ubicación:
                span.ms-2= plan.internacion.Cama && plan.internacion.Cama.Habitacion ? `${plan.internacion.Cama.Habitacion.Ala.Sector.nombre} - Hab. ${plan.internacion.Cama.Habitacion.codigo} - Cama ${plan.internacion.Cama.numero_cama}` : '-'
            .col-md-3
              p.mb-2
                strong.text-muted Internación:
                span.ms-2 ID ##{plan.id_internacion}
        else
          .alert.alert-warning.mb-3
            i.fas.fa-exclamation-triangle.me-2
            strong Paciente internado de emergencia
            p.mb-0.mt-2 Los datos del paciente serán completados posteriormente.
          .row
            .col-md-3
              p.mb-2
                strong.text-muted Sexo:
                if plan.internacion && plan.internacion.isDesconocido === true
                  span.ms-2.badge.bg-info Masculino
                else if plan.internacion && plan.internacion.isDesconocido === false
                  span.ms-2.badge.bg-danger Femenino
                else
                  span.ms-2.text-muted No especificado
            .col-md-3
              p.mb-2
                strong.text-muted Ubicación:
                span.ms-2= plan.internacion && plan.internacion.Cama && plan.internacion.Cama.Habitacion ? `Hab. ${plan.internacion.Cama.Habitacion.codigo} - Cama ${plan.internacion.Cama.numero_cama}` : '-'
            .col-md-3
              p.mb-2
                strong.text-muted Fecha Internación:
                span.ms-2= plan.internacion && plan.internacion.fecha_internacion ? new Date(plan.internacion.fecha_internacion).toLocaleDateString('es-AR') : '-'
            .col-md-3
              p.mb-2
                strong.text-muted Internación:
                span.ms-2 ID ##{plan.id_internacion}

    // Información del Plan de Cuidado
    .card.mb-4.shadow
      .card-header.bg-success.text-white
        h5.mb-0
          i.fas.fa-clipboard-list.me-2
          | Información del Plan de Cuidado
      .card-body
        .row.mb-3
          .col-md-3
            p.mb-2
              strong.text-muted ID del Plan:
              span.ms-2 ##{plan.id}
          .col-md-3
            p.mb-2
              strong.text-muted Tipo:
              if plan.tipo
                if plan.tipo.nombre === 'Transitorio'
                  span.badge.bg-info.ms-2
                    i.fas.fa-clock.me-1
                    | Transitorio
                else if plan.tipo.nombre === 'Final'
                  span.badge.bg-success.ms-2
                    i.fas.fa-check-circle.me-1
                    | Final
                else
                  span.badge.bg-secondary.ms-2= plan.tipo.nombre
              else
                span.ms-2 -
          .col-md-3
            p.mb-2
              strong.text-muted Fecha:
              span.ms-2= new Date(plan.fecha).toLocaleDateString('es-AR') + ' ' + new Date(plan.fecha).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' })
          .col-md-3
            p.mb-2
              strong.text-muted Responsable:
              span.ms-2= plan.persona ? `${plan.persona.nombre} ${plan.persona.apellido}` : '-'
        
        .row
          .col-md-12
            p.mb-2
              strong.text-muted Descripción del Plan:
            .alert.alert-light.mb-0
              p.mb-0= plan.devolucion

    // Receta Médica Asociada
    if plan.id_reseta && plan.reseta
      .card.shadow
        .card-header.bg-info.text-white
          h5.mb-0
            i.fas.fa-prescription.me-2
            | Receta Médica Asociada
        .card-body
          .row.mb-3
            .col-md-4
              p.mb-2
                strong.text-muted ID de Receta:
                span.badge.bg-info.ms-2 ##{plan.reseta.id}
            .col-md-4
              p.mb-2
                strong.text-muted Fecha de Emisión:
                span.ms-2= new Date(plan.reseta.fecha).toLocaleDateString('es-AR') + ' ' + new Date(plan.reseta.fecha).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' })
            .col-md-4
              p.mb-2
                strong.text-muted Prescrito por:
                span.ms-2= plan.reseta.persona ? `${plan.reseta.persona.nombre} ${plan.reseta.persona.apellido}` : '-'

          if plan.reseta.renglones && plan.reseta.renglones.length > 0
            hr
            h6.mb-3
              i.fas.fa-pills.me-2
              | Medicamentos Prescritos

            .table-responsive
              table.table.table-sm.table-bordered.table-hover
                thead.table-light
                  tr
                    th.text-center(style="width: 5%;") #
                    th(style="width: 30%;")
                      i.fas.fa-capsules.me-1
                      | Medicamento
                    th(style="width: 20%;")
                      i.fas.fa-balance-scale.me-1
                      | Dosis
                    th(style="width: 15%;")
                      i.fas.fa-calendar-alt.me-1
                      | Duración
                    th(style="width: 30%;")
                      i.fas.fa-comment-medical.me-1
                      | Indicaciones
                tbody
                  each renglon, idx in plan.reseta.renglones
                    tr
                      td.text-center= idx + 1
                      td
                        if renglon.medicamento
                          strong.text-primary= renglon.medicamento.marca_comercial
                          br
                          small.text-muted= renglon.medicamento.presentacion
                          br
                          small.text-muted.fst-italic Lab: #{renglon.medicamento.laboratorio}
                        else
                          span.text-muted Medicamento no disponible
                      td
                        span.badge.bg-light.text-dark= renglon.dosis
                      td
                        span.badge.bg-light.text-dark= renglon.duracion
                      td= renglon.indicaciones || '-'

            .alert.alert-info.mt-3.mb-0
              i.fas.fa-info-circle.me-2
              strong Total de medicamentos:
              span.ms-2= plan.reseta.renglones.length

          else
            .alert.alert-warning.mb-0
              i.fas.fa-exclamation-triangle.me-2
              | Esta receta no tiene medicamentos asociados
    else
      .card.shadow
        .card-header.bg-light
          h5.mb-0.text-muted
            i.fas.fa-prescription.me-2
            | Receta Médica
        .card-body
          .alert.alert-info.mb-0
            i.fas.fa-info-circle.me-2
            | Este plan de cuidado no tiene una receta médica asociada

    // Botones de Navegación
    .row.mt-4.mb-4
      .col-12.d-flex.gap-2
        a.btn.btn-secondary(href=`/enfermeria/planes-cuidado/${plan.id_internacion}`)
          i.fas.fa-arrow-left.me-2
          | Volver al Historial
        a.btn.btn-outline-primary(href=`/internacion/details/${plan.id_internacion}`)
          i.fas.fa-bed.me-2
          | Ver Internación

  else
    .alert.alert-warning.mt-4 Plan de cuidado no encontrado.
